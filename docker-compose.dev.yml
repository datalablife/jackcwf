# Docker Compose configuration for local development
# This file is for testing the production container locally
# For actual development, use: uv run reflex run

version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: 3.12
        NODE_VERSION: 20

    container_name: working-dev

    ports:
      - "3000:3000"  # Frontend
      - "8000:8000"  # Backend

    environment:
      # Application settings
      - APP_NAME=working
      - ENVIRONMENT=development
      - DEBUG=true
      - REFLEX_ENV=production  # Test production mode locally
      - FRONTEND_PORT=3000
      - BACKEND_PORT=8000

      # Database connection (use your cloud PostgreSQL)
      # Override with your actual DATABASE_URL
      - DATABASE_URL=${DATABASE_URL:-postgresql://user:password@pgvctor.jackcwf.com:5432/working}

    # Restart policy
    restart: unless-stopped

    # Health check (same as production)
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Optional: Mount volumes for development (uncomment if needed)
    # volumes:
    #   - .:/app
    #   - /app/.venv  # Exclude virtual environment
    #   - /app/.web   # Exclude compiled frontend

    # Logs configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Add a local PostgreSQL for development
# Uncomment if you want to test with a local database
#
# services:
#   postgres:
#     image: postgres:15-alpine
#     container_name: working-postgres
#     environment:
#       - POSTGRES_USER=working
#       - POSTGRES_PASSWORD=working
#       - POSTGRES_DB=working
#     ports:
#       - "5432:5432"
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U working"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
#
# volumes:
#   postgres_data:
