services:
  app:
    image: mg8c40oowo80o08o0gsw0gwc:3692de12e493ff0bb343810c872bac002c86f956
    networks:
      - coolify
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s
    expose:
      - 3000
      - 8000

    environment:
      - APP_NAME=working
      - ENVIRONMENT=production
      - DEBUG=false
      - REFLEX_ENV=production
      - FRONTEND_PORT=3000
      - BACKEND_PORT=8000
      - COOLIFY_URL=https://coolpanel.jackcwf.com
      - COOLIFY_FQDN=jackcwf.coolify.io

    labels:
      # 基础配置
      - traefik.enable=true

      # 中间件定义
      - traefik.http.middlewares.gzip.compress=true
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.websocket-upgrade.headers.customrequestheaders.Connection=upgrade
      - traefik.http.middlewares.websocket-upgrade.headers.customrequestheaders.Upgrade=websocket

      # HTTP 路由 - 重定向到 HTTPS
      - traefik.http.routers.http-0-mg8c40oowo80o08o0gsw0gwc.entryPoints=http
      - traefik.http.routers.http-0-mg8c40oowo80o08o0gsw0gwc.middlewares=redirect-to-https
      - traefik.http.routers.http-0-mg8c40oowo80o08o0gsw0gwc.rule=Host(`www.jackcwf.com`) && PathPrefix(`/`)
      - traefik.http.routers.http-0-mg8c40oowo80o08o0gsw0gwc.service=http-0-mg8c40oowo80o08o0gsw0gwc
      # HTTP 优先级与 HTTPS 相同
      - traefik.http.routers.http-0-mg8c40oowo80o08o0gsw0gwc.priority=10

      # HTTPS 主路由 - 前端（降低优先级给 WebSocket 路由）
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.entryPoints=https
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.middlewares=gzip
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.rule=Host(`www.jackcwf.com`) && PathPrefix(`/`)
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.service=https-0-mg8c40oowo80o08o0gsw0gwc
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.tls=true
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.tls.certresolver=letsencrypt
      # ⭐ 降低优先级，让 WebSocket 路由优先匹配
      - traefik.http.routers.https-0-mg8c40oowo80o08o0gsw0gwc.priority=10

      # HTTPS WebSocket 路由 - 后端
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.entryPoints=https
      # 注意：Traefik 默认能转发 WebSocket 头部
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.rule=Host(`www.jackcwf.com`) && PathPrefix(`/_event`)
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.service=https-websocket-mg8c40oowo80o08o0gsw0gwc
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.tls=true
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.tls.certresolver=letsencrypt
      # ⭐ 高优先级确保 /_event 优先于通用 / 路由
      - traefik.http.routers.https-websocket-mg8c40oowo80o08o0gsw0gwc.priority=20

      # 服务配置
      - traefik.http.services.http-0-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.port=3000
      - traefik.http.services.http-0-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.scheme=http
      - traefik.http.services.https-0-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.port=3000
      - traefik.http.services.https-0-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.scheme=http
      - traefik.http.services.https-websocket-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.port=8000
      - traefik.http.services.https-websocket-mg8c40oowo80o08o0gsw0gwc.loadbalancer.server.scheme=http

networks:
  coolify:
    external: true
