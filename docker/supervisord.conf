[supervisord]
# Supervisor main process configuration
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

# User permissions
user=root

# Unix Socket (optional)
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

# RPC interface (for supervisorctl)
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# RPC interface (for remote monitoring)
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# ============================================
# Program 1: Backend (FastAPI)
# ============================================
[program:backend]
# Startup command
command=python -m uvicorn src.main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 2 \
    --log-level info \
    --access-log

# Working directory
directory=/app

# Auto start and restart
autostart=true
autorestart=true
startsecs=10          ; Wait 10 seconds after start to check success
startretries=3        ; Max 3 retries on failure
stopasgroup=true      ; Stop child processes when stopping

# Log configuration
stdout_logfile=/var/log/app/backend.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/backend_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# Environment variables
environment=PYTHONUNBUFFERED=1,PYTHONDONTWRITEBYTECODE=1

# Priority (lower values start first)
priority=100

# ============================================
# Program 2: Nginx (Reverse Proxy + Static Files)
# ============================================
[program:nginx]
# Startup command (nginx reverse proxy on port 80)
# Serves both React frontend (static files) and proxies API to backend
command=nginx -g 'daemon off;'

# Working directory
directory=/app

# Auto start and restart
autostart=true
autorestart=true
startsecs=5           ; Wait 5 seconds for startup
startretries=3        ; Retry up to 3 times on failure
stopasgroup=true      ; Stop all child processes

# Log configuration
stdout_logfile=/var/log/app/nginx.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/nginx_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# Environment variables
environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin

# Priority (start after Backend)
priority=200

# ============================================
# Program 3: Health Monitor (Python monitoring script)
# ============================================
[program:healthmonitor]
# Start monitoring script
command=python /app/scripts/monitor/health_monitor.py

# Working directory
directory=/app

# Auto start and restart
autostart=true
autorestart=true
startsecs=30          ; Wait 30 seconds (let other services start first)
startretries=3
stopasgroup=true

# Log configuration
stdout_logfile=/var/log/app/health_monitor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/health_monitor_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# Environment variables
environment=PYTHONUNBUFFERED=1

# Priority (starts last)
priority=300

# ============================================
# Process Group (for batch management)
# ============================================
[group:services]
programs=backend,nginx,healthmonitor
priority=999
