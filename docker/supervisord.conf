[supervisord]
# Supervisor 主进程配置
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

# 用户权限
user=root

# 监听 Unix Socket (可选)
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

# RPC 接口 (用于 supervisorctl)
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# RPC 接口 (用于远程监控)
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# ============================================
# Program 1: Backend (FastAPI)
# ============================================
[program:backend]
# 启动命令
command=python -m uvicorn src.main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 2 \
    --log-level info \
    --access-log

# 工作目录
directory=/app

# 自动启动和重启
autostart=true
autorestart=true
startsecs=10          ; 启动后等待 10 秒判断是否成功
startretries=3        ; 失败最多重试 3 次
stopasgroup=true      ; 停止时同时停止子进程

# 日志配置
stdout_logfile=/var/log/app/backend.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/backend_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# 环境变量
environment=PYTHONUNBUFFERED=1,PYTHONDONTWRITEBYTECODE=1

# 优先级 (低值优先启动)
priority=100

# ============================================
# Program 2: Frontend (Nginx + React)
# ============================================
[program:frontend]
# 启动命令 (使用 Nginx 反向代理)
command=/bin/bash -c "cd /usr/share/nginx/html && nginx -g 'daemon off;'"

# 工作目录
directory=/app

# 自动启动和重启
autostart=true
autorestart=true
startsecs=5           ; 等待 5 秒
startretries=3
stopasgroup=true

# 日志配置
stdout_logfile=/var/log/app/frontend.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/frontend_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# 环境变量
environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin

# 优先级 (在 Backend 之后启动)
priority=200

# ============================================
# Program 3: Health Monitor (Python 监控脚本)
# ============================================
[program:healthmonitor]
# 启动监控脚本
command=python /app/scripts/monitor/health_monitor.py

# 工作目录
directory=/app

# 自动启动和重启
autostart=true
autorestart=true
startsecs=30          ; 等待 30 秒 (前两个服务启动)
startretries=3
stopasgroup=true

# 日志配置
stdout_logfile=/var/log/app/health_monitor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/app/health_monitor_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# 环境变量
environment=PYTHONUNBUFFERED=1

# 优先级 (最后启动)
priority=300

# ============================================
# Event Listener: 崩溃告警 (可选)
# ============================================
[eventlistener:crash_notifier]
buffer_size=100
events=PROCESS_STATE_FATAL,TICK_60
command=python /app/scripts/monitor/crash_listener.py

# 日志配置
stdout_logfile=/var/log/app/crash_notifier.log
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=3

# ============================================
# 进程组 (方便批量管理)
# ============================================
[group:services]
programs=backend,frontend,healthmonitor
priority=999

# ============================================
# 日志轮转配置
# ============================================
[logrotate]
target_directory=/var/log/app
size_limit=100000000    ; 100MB
backup_count=5
