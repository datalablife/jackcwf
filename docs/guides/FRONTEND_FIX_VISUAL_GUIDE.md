# Frontend API Integration Fixes - Visual Guide

## Problem Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    CURRENT BROKEN STATE                          │
└─────────────────────────────────────────────────────────────────┘

User Opens App
    ↓
   Issue 2: getConversations()
   ├─ Expects: [{ id, title, ... }]
   ├─ Receives: { items: [...], total, skip, limit }
   └─ Result: ❌ TypeError - empty sidebar

User Clicks "New Conversation"
    ↓
   Issue 1: createConversation()
   ├─ Sends: { title: "New Conversation" }
   ├─ Backend needs: { title, system_prompt, model? }
   └─ Result: ❌ 422 Validation Error

User Types Message
    ↓
   Issue 4: useChat.sendMessage()
   ├─ Uses: /conversations/thread_123/stream
   ├─ Backend expects: /conversations/123/stream
   └─ Result: ❌ 404 Not Found

User Wait for Auto-Title
    ↓
   Issue 5: generateTitle()
   ├─ Calls: POST /conversations/{id}/generate-title
   ├─ Endpoint: DOESN'T EXIST
   └─ Result: ❌ 404 (silent failure)

Real-time Features
    ↓
   Issue 3: useTypingIndicator()
   ├─ URL: ws://localhost:8000/ws (hardcoded)
   ├─ Protocol: Missing handshake
   └─ Result: ❌ Connection rejected

End Result: ❌ APP IS BROKEN - Nothing works
```

---

## Solution Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    FIXED STATE (GOAL)                            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     NEW UTILITY LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  threadUtils.ts                  titleGenerator.ts              │
│  ├─ createThreadId()             ├─ generateTitleFromContent()  │
│  ├─ getConversationId()          ├─ generateTitleFromMessages() │
│  ├─ getConversationIdAsNumber()  ├─ sanitizeTitle()            │
│  ├─ ensureThreadId()             ├─ isAutoGeneratedTitle()     │
│  └─ compareThreadIds()           └─ generateDefaultTitle()     │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
            ↑                              ↑
            │ (Used by)                   │ (Used by)
            │                              │
┌──────────────────────┬──────────────────────────────────────────┐
│ UPDATED FILES        │                                          │
├──────────────────────┼──────────────────────────────────────────┤
│                      │                                          │
│ api.ts               │                                          │
│ ├─ [FIX 1] Add       │  App.tsx                                │
│ │   system_prompt    │  ├─ [FIX 2] Parse items array          │
│ │   parameter        │  ├─ [FIX 4] Use conversationId         │
│ ├─ [FIX 2] Add       │  └─ [FIX 5] Use local title gen        │
│ │   PaginatedResponse│                                         │
│ │   interface        │  hooks/index.ts                         │
│ └─ [FIX 5] Remove    │  ├─ [FIX 1] Add system_prompt          │
│    generateTitle()   │  ├─ [FIX 3] Replace useTypingInd.      │
│                      │  ├─ [FIX 4] Use conversationId         │
│                      │  └─ [FIX 5] Use titleGenerator         │
│                      │                                          │
└──────────────────────┴──────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    API CALLS (FIXED)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  POST /conversations                                             │
│  ├─ [FIX 1] Includes: system_prompt ✓                           │
│  └─ Returns: { id, title, created_at, ... } ✓                  │
│                                                                   │
│  GET /conversations                                              │
│  ├─ [FIX 2] Returns: { items: [...], total, skip, limit } ✓   │
│  └─ Frontend parses: response.data.items ✓                      │
│                                                                   │
│  POST /conversations/123/stream                                  │
│  ├─ [FIX 4] URL uses: 123 (not thread_123) ✓                   │
│  └─ Returns: SSE stream of chunks ✓                             │
│                                                                   │
│  PATCH /conversations/123                                        │
│  ├─ [FIX 5] Updates title directly ✓                            │
│  └─ No /generate-title endpoint needed ✓                        │
│                                                                   │
│  WebSocket /ws/conversations/123                                 │
│  ├─ [FIX 3] Dynamic URL (no localhost) ✓                        │
│  └─ [FIX 3] Proper handshake protocol ✓                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│                   USER EXPERIENCE (FIXED)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ✓ App loads → Sidebar shows conversations                      │
│  ✓ Click new → Creates conversation immediately                │
│  ✓ Send message → Returns response without errors              │
│  ✓ First message → Title auto-generates intelligently          │
│  ✓ Real-time → WebSocket shows typing indicator                │
│  ✓ Reload → All data persists correctly                        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Issue-by-Issue Breakdown

### Issue 1: Missing system_prompt

```
BEFORE:                           AFTER:
┌──────────────────┐            ┌──────────────────────────────┐
│ createConversation │            │ createConversation             │
├──────────────────┤            ├──────────────────────────────┤
│ Data Sent:       │            │ Data Sent:                   │
│                  │            │                              │
│ {                │            │ {                            │
│   title: "..."   │  ────→     │   title: "...",              │
│ }                │            │   system_prompt: "...",      │
│                  │            │   model: "claude-..."        │
│                  │            │ }                            │
└──────────────────┘            └──────────────────────────────┘
         ↓                                 ↓
    422 Error                         Success ✓
    (Missing field)                  (Created)
```

### Issue 2: Response Parsing

```
BEFORE:                                  AFTER:
┌────────────────────────────┐         ┌──────────────────────────────┐
│ Backend Response:          │         │ Backend Response:            │
├────────────────────────────┤         ├──────────────────────────────┤
│ {                          │         │ {                            │
│   items: [...],            │         │   items: [                   │
│   total: 5,                │         │     { id, title, ... },      │
│   skip: 0,                 │         │     { id, title, ... }       │
│   limit: 50                │         │   ],                         │
│ }                          │         │   total: 5,                  │
└────────────────────────────┘         │   skip: 0,                   │
        ↓                              │   limit: 50                  │
 Frontend Code:                        │ }                            │
 response.data.map(...)  ❌            └──────────────────────────────┘
 (data is object!)                             ↓
                                        Frontend Code:
                                        response.data?.items?.map(...) ✓
                                        (items is array!)
```

### Issue 4: Thread ID Format

```
BEFORE:                           AFTER:
┌────────────────────────────┐   ┌──────────────────────────────┐
│ threadId = "thread_123"    │   │ threadId = "thread_123"      │
│                            │   │                              │
│ API Call:                  │   │ Conversion:                  │
│ /conversations/thread_123/ │   │ conversationId = 123         │
│ stream ❌                   │   │                              │
│                            │   │ API Call:                    │
│ Backend expects: 123       │   │ /conversations/123/          │
│ Gets: thread_123           │   │ stream ✓                     │
│ Result: 404               │   │                              │
└────────────────────────────┘   │ Uses: getConversationId()   │
                                 └──────────────────────────────┘
```

### Issue 5: Title Generation

```
BEFORE:                              AFTER:
┌────────────────────────────┐      ┌──────────────────────────────┐
│ First Message Sent:        │      │ First Message Sent:          │
│ "What is AI?"              │      │ "What is AI?"                │
│        ↓                   │      │        ↓                     │
│ API Call:                  │      │ Local Function:              │
│ POST /conversations/{id}/  │      │ generateTitleFromContent()   │
│ generate-title ❌          │      │        ↓                     │
│ (endpoint doesn't exist)   │      │ Extracts: "What is AI?"      │
│        ↓                   │      │ (first sentence)             │
│ Error: 404                │      │        ↓                     │
│ Title stays: "New          │      │ API Call:                    │
│ Conversation" ❌           │      │ PATCH /conversations/{id}    │
│                            │      │ { title: "What is AI?" } ✓   │
└────────────────────────────┘      │        ↓                     │
                                    │ Title Updated ✓              │
                                    └──────────────────────────────┘
```

### Issue 3: WebSocket URL

```
BEFORE:                              AFTER:
┌────────────────────────────┐      ┌──────────────────────────────┐
│ Hardcoded URL:             │      │ Dynamic URL:                 │
│ ws://localhost:8000/ws ❌  │      │ buildConversationWsUrl()     │
│                            │      │ → ws://current-host/ws/...   │
│ Environment:               │      │                              │
│ ├─ Works: localhost dev    │      │ Environment:                 │
│ ├─ Fails: cloud dev        │      │ ├─ Works: localhost dev      │
│ └─ Fails: production       │      │ ├─ Works: cloud dev          │
│                            │      │ └─ Works: production ✓       │
│ Token in URL:              │      │                              │
│ ws://...?token=xyz ❌      │      │ Token in Headers:            │
│ (logged by server!)        │      │ Authorization: Bearer xyz ✓  │
│                            │      │ (secure!)                    │
└────────────────────────────┘      └──────────────────────────────┘
```

---

## Data Flow Comparison

### BEFORE (Broken)

```
User Opens App
    ↓
   ❌ GET /conversations
   └─ Returns: { items: [...], total, skip, limit }

App Code:
   response.data.map(...) ❌ TypeError

Result: Empty sidebar, no threads displayed

User Creates Conversation
    ↓
   ❌ POST /conversations
   ├─ Data: { title }
   └─ Missing: system_prompt (required!)

Backend Response: 422 Validation Error
Result: Conversation not created

User Sends Message
    ↓
   ❌ POST /conversations/thread_123/stream
   └─ URL wrong (backend expects: 123)

Backend Response: 404 Not Found
Result: Message fails silently

Auto-Title Generation
    ↓
   ❌ POST /conversations/{id}/generate-title
   └─ Endpoint doesn't exist

Backend Response: 404 Not Found
Result: Title stays default, error ignored

WebSocket Real-time
    ↓
   ❌ ws://localhost:8000/ws
   ├─ Hardcoded URL (fails on cloud)
   ├─ Token in URL (security issue)
   └─ No handshake protocol

Result: Connection fails, no typing indicator
```

### AFTER (Fixed)

```
User Opens App
    ↓
   ✓ GET /conversations
   └─ Returns: { items: [...], total, skip, limit }

App Code:
   const items = response.data?.items || []
   items.map(...) ✓ Works

Result: Sidebar loads with all conversations

User Creates Conversation
    ↓
   ✓ POST /conversations
   ├─ Data: { title, system_prompt, model }
   └─ All required fields provided

Backend Response: 201 Created
Result: Conversation created successfully

User Sends Message
    ↓
   ✓ POST /conversations/123/stream
   ├─ Extracted: conversationId = getConversationId(threadId)
   └─ URL correct (numeric ID only)

Backend Response: 200 + SSE stream
Result: Message sent, response streamed

Auto-Title Generation
    ↓
   ✓ generateTitleFromContent(message)
   ├─ Local function (no API call)
   ├─ Extracts first sentence
   └─ Updates via PATCH /conversations/{id}

Result: Title updates immediately, saved to DB

WebSocket Real-time
    ↓
   ✓ ws://current-host/ws/conversations/{id}
   ├─ Dynamic URL (works everywhere)
   ├─ Token in Authorization header (secure)
   └─ Proper handshake with user_id

Result: Connection succeeds, typing indicator works
```

---

## Implementation Timeline

```
Step 1: Prepare (2 min)
├─ Read FRONTEND_FIX_QUICK_REFERENCE.md
└─ Have all files open in editor

Step 2: Create Utilities (3 min)
├─ Create threadUtils.ts
└─ Create titleGenerator.ts

Step 3: Fix Critical Issues (15 min)
├─ Fix 1: api.ts - Add system_prompt (2 min)
├─ Fix 2: App.tsx - Parse response (2 min)
└─ Fix 4: All files - Use conversationId (10 min)

Step 4: Fix Other Issues (8 min)
├─ Fix 5: Implement title generation (3 min)
└─ Fix 3: Update WebSocket (5 min)

Step 5: Test (10 min)
├─ Check console for errors
├─ Test conversation creation
├─ Test message sending
└─ Verify titles auto-generate

Total Time: ~38 minutes
```

---

## Success Indicators

### Console Output - BEFORE (Broken)
```
⚠️ Failed to load conversations: TypeError: response.data.map is not a function
⚠️ Failed to create thread: Error: 422 Unprocessable Entity
⚠️ Failed to send message: Error: 404 Not Found
⚠️ Failed to generate title: Error: 404 Not Found
⚠️ Failed to setup typing indicator: WebSocket connection error
```

### Console Output - AFTER (Fixed)
```
✓ Conversations loaded: 5 threads
✓ Thread created: thread_456
✓ Message sent: "What is AI?"
✓ Title generated: "What is AI?"
✓ WebSocket connected: ws://localhost:8000/ws/conversations/456
```

### Network Tab - BEFORE (Broken)
```
GET /conversations         404 ❌
POST /conversations        422 ❌
POST /conversations/thread_123/stream    404 ❌
POST /conversations/123/generate-title   404 ❌
WebSocket /ws?token=...    error ❌
```

### Network Tab - AFTER (Fixed)
```
GET /conversations         200 ✓ (items array)
POST /conversations        201 ✓ (created)
POST /conversations/123/stream           200 ✓ (SSE stream)
PATCH /conversations/123   200 ✓ (title updated)
WebSocket /ws/conversations/123          101 ✓ (upgraded)
```

---

## Dependency Map

```
threadUtils.ts (NEW)
├─ No external dependencies
└─ Used by:
   ├─ App.tsx
   └─ hooks/index.ts

titleGenerator.ts (NEW)
├─ No external dependencies
└─ Used by:
   ├─ App.tsx
   └─ hooks/index.ts

api.ts (MODIFIED)
├─ Import: threadUtils, titleGenerator
├─ Updates:
│  ├─ createConversation (parameter)
│  ├─ getConversations (return type)
│  └─ Remove generateTitle
└─ Used by:
   ├─ App.tsx
   └─ hooks/index.ts

hooks/index.ts (MODIFIED)
├─ Import: threadUtils, titleGenerator, api, BackendWebSocketAdapter
├─ Updates:
│  ├─ useAutoTitle (use titleGenerator)
│  ├─ useTypingIndicator (use BackendWebSocketAdapter)
│  ├─ useChat (use conversationId)
│  ├─ useThread (add system_prompt)
│  └─ useStreaming (use conversationId)
└─ Used by:
   └─ App.tsx

App.tsx (MODIFIED)
├─ Import: threadUtils, titleGenerator, api, hooks
├─ Updates:
│  ├─ loadConversations (parse items)
│  ├─ handleDeleteThread (use conversationId)
│  └─ handleSendMessage (use titleGenerator)
└─ Root component
```

---

## Quick Visual Reference

### Thread ID Conversion
```
threadId (frontend)        conversationId (backend API)
    ↓                             ↓
"thread_123"  ←→ getConversationId()  ←→  123
                 createThreadId()
```

### API Request Flow
```
Component                Hook                     API              Backend
    ↓                     ↓                        ↓                  ↓
  setMessage() ─→ useChat ─→ (conversationId) ─→ /conversations/123/ ─→ Stream
                                                   stream
```

### Title Generation Flow
```
Message Content             Local Function            Backend Update
    ↓                            ↓                         ↓
"What is AI?" ─→ generateTitleFromContent() ─→ PATCH /conversations/123
                        ↓
                  Extract sentence
                        ↓
                  "What is AI?"
```

---

End of Visual Guide. Use this document along with the code snippets for implementation.
