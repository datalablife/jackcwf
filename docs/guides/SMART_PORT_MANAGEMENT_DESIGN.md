# æ™ºèƒ½ç«¯å£ç®¡ç†è®¾è®¡æ–‡æ¡£
## ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ä¸ªæ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-11-25
**é—®é¢˜**: åç«¯å¯åŠ¨æ—¶ç«¯å£è¢«å ç”¨å¯¼è‡´è‡ªåŠ¨å…³é—­
**è§£å†³æ–¹æ¡ˆ**: é›†æˆåˆ° main.py çš„æ™ºèƒ½ç«¯å£ç®¡ç†ç³»ç»Ÿ

---

## ğŸ¤” é—®é¢˜é™ˆè¿°

ç”¨æˆ·å¯åŠ¨åç«¯æ—¶çœ‹åˆ°ï¼š
```
ERROR:    [Errno 98] error while attempting to bind on address ('0.0.0.0', 8000): address already in use
INFO:     Waiting for application shutdown.
# åº”ç”¨è‡ªåŠ¨å…³é—­
```

**åŸå› **: ä¹‹å‰åœ¨åå°å¯åŠ¨çš„è¿›ç¨‹ä»å ç”¨ç«¯å£ 8000

**åŸå§‹æƒ³æ³•**: åˆ›å»ºå¤–éƒ¨è„šæœ¬æ£€æŸ¥å¹¶æ€æ­»å ç”¨çš„è¿›ç¨‹

**é—®é¢˜**:
- âŒ ç”¨æˆ·éœ€è¦è®°ä½ç”¨è„šæœ¬è€Œä¸æ˜¯ç›´æ¥ uvicorn
- âŒ è„šæœ¬ä¸ç¨‹åºè§£è€¦ï¼Œå®¹æ˜“é—æ¼
- âŒ ç”Ÿäº§ç¯å¢ƒä¸åº”è¯¥è‡ªåŠ¨æ€æ­»è¿›ç¨‹ï¼ˆå±é™©ï¼ï¼‰

---

## ğŸ¯ æœ€ç»ˆæ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³

**å°†ç«¯å£æ£€æŸ¥é›†æˆåˆ° main.pyï¼Œæ ¹æ®ç¯å¢ƒæ™ºèƒ½å¤„ç†**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å¯åŠ¨:                                    â”‚
â”‚ python -m uvicorn src.main:app ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py __main__ å—æ‰§è¡Œ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ£€æŸ¥ ENVIRONMENT å˜é‡                    â”‚
â”‚ 2. è°ƒç”¨ PortManager.ensure_port_available() â”‚
â”‚ 3. æ ¹æ®ç¯å¢ƒå†³å®šç­–ç•¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚
       â–¼                 â–¼
   å¼€å‘ç¯å¢ƒ          ç”Ÿäº§ç¯å¢ƒ
   auto-kill        æŠ¥é”™é€€å‡º
   å¯åŠ¨æˆåŠŸ         éœ€è¦äººå·¥å¹²é¢„
```

### æ¶æ„è®¾è®¡

#### 1. ä¸“ç”¨æ¨¡å—ï¼š`src/infrastructure/port_manager.py`

**èŒè´£**:
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
- è·å–å ç”¨è¿›ç¨‹çš„ PID
- æ€æ­»è¿›ç¨‹ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- éªŒè¯ç«¯å£é‡Šæ”¾

**ç‰¹ç‚¹**:
```python
class PortManager:
    # ç¯å¢ƒæ£€æµ‹
    IS_DEVELOPMENT = os.getenv("ENVIRONMENT") != "production"

    # æ–¹æ³•ï¼š
    - is_port_in_use(port)           # ç«¯å£æ£€æŸ¥
    - get_process_using_port(port)   # PID è·å–
    - kill_process(pid)               # è¿›ç¨‹æ€æ­»
    - check_and_clean_port()          # ä¸»é€»è¾‘
```

**ä¼˜åŠ¿**:
- âœ… å•ä¸€èŒè´£ï¼šåªå¤„ç†ç«¯å£ç®¡ç†
- âœ… å¯å¤ç”¨ï¼šå¯è¢«å…¶ä»–æ¨¡å—å¯¼å…¥
- âœ… å¯æµ‹è¯•ï¼šé€»è¾‘ç‹¬ç«‹æ¸…æ™°
- âœ… å¯é…ç½®ï¼šæ”¯æŒç¯å¢ƒå˜é‡

#### 2. é›†æˆç‚¹ï¼š`src/main.py` __main__ å—

**ä¿®æ”¹å†…å®¹**:
```python
if __name__ == "__main__":
    import uvicorn
    from src.infrastructure.port_manager import ensure_port_available

    # è·å–é…ç½®
    port = int(os.getenv("PORT", "8000"))

    # æ£€æŸ¥ç«¯å£
    if not ensure_port_available(port=port):
        sys.exit(1)

    # å¯åŠ¨æœåŠ¡å™¨
    uvicorn.run(...)
```

**ä¼˜åŠ¿**:
- âœ… æ— éœ€æ”¹å˜å¯åŠ¨æ–¹å¼
- âœ… ä¸ main.py è€¦åˆï¼Œä¸æ˜“é—æ¼
- âœ… è‡ªåŠ¨æ‰§è¡Œï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… æ”¯æŒ `python -m uvicorn` å’Œç›´æ¥è¿è¡Œ

---

## ğŸ”„ æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: å¤–éƒ¨è„šæœ¬ï¼ˆæœ€åˆæƒ³æ³•ï¼‰

```bash
python run_backend.py
```

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| æ˜“ç”¨æ€§ | âš ï¸ éœ€è¦è®°ä½è„šæœ¬ |
| å¯ç»´æŠ¤æ€§ | âš ï¸ è„šæœ¬ä¸ç¨‹åºåˆ†ç¦» |
| ç”Ÿäº§å®‰å…¨æ€§ | âš ï¸ è„šæœ¬ä¹Ÿä¼šæ€è¿›ç¨‹ |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ | âš ï¸ éœ€è¦é¢å¤–æ­¥éª¤ |
| å­¦ä¹ æˆæœ¬ | âš ï¸ éœ€è¦æ–‡æ¡£æŒ‡å¯¼ |

### æ–¹æ¡ˆ B: main.py å†…ç½®ï¼ˆæœ€ç»ˆæ–¹æ¡ˆï¼‰âœ…

```bash
python -m uvicorn src.main:app --host 0.0.0.0 --port 8000
```

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| æ˜“ç”¨æ€§ | âœ… æ— éœ€æ”¹å˜ï¼Œè‡ªåŠ¨å¤„ç† |
| å¯ç»´æŠ¤æ€§ | âœ… é›†æˆåˆ°ä¸»ç¨‹åº |
| ç”Ÿäº§å®‰å…¨æ€§ | âœ… ç¯å¢ƒåŒºåˆ†ï¼Œæ‹’ç»è‡ªåŠ¨æ€ |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ | âœ… å®Œå…¨è‡ªåŠ¨ |
| å­¦ä¹ æˆæœ¬ | âœ… å¯¹ç”¨æˆ·é€æ˜ |

---

## ğŸ›¡ï¸ å®‰å…¨è®¾è®¡

### å¼€å‘ç¯å¢ƒï¼šè‡ªåŠ¨åŒ–ä¼˜å…ˆ

```python
if IS_DEVELOPMENT:
    # è‡ªåŠ¨æ¸…ç†ç«¯å£ï¼Œè®©å¼€å‘è€…ä¸“æ³¨ä»£ç 
    kill_process_if_needed()
    start_server()  # âœ… æˆåŠŸç‡æ¥è¿‘ 100%
```

**å¥½å¤„**:
- å‡å°‘å¼€å‘æ‘©æ“¦
- å¿«é€Ÿè¿­ä»£
- é¿å…é‡å¤æ‰‹åŠ¨æ€è¿›ç¨‹

### ç”Ÿäº§ç¯å¢ƒï¼šå®‰å…¨ä¼˜å…ˆ

```python
if not IS_DEVELOPMENT:
    # æ‹’ç»è‡ªåŠ¨æ“ä½œï¼Œè¦æ±‚äººå·¥å®¡æŸ¥
    if port_in_use:
        logger.error("Port conflict - please review and handle manually")
        exit(1)
```

**å¥½å¤„**:
- é˜²æ­¢æ„å¤–æ€æ­»é‡è¦è¿›ç¨‹
- é˜²æ­¢æ•°æ®æŸå
- è¦æ±‚ DevOps äººå‘˜å®¡æŸ¥æƒ…å†µ
- é¿å…è‡ªåŠ¨åŒ–é™·é˜±

### ç¯å¢ƒå˜é‡æ§åˆ¶

```bash
# å¼€å‘ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
unset ENVIRONMENT
python -m uvicorn ...  # âœ… è‡ªåŠ¨æ€è¿›ç¨‹

# ç”Ÿäº§ç¯å¢ƒï¼ˆæ˜ç¡®è®¾ç½®ï¼‰
export ENVIRONMENT=production
python -m uvicorn ...  # âŒ æŠ¥é”™ï¼Œéœ€è¦äººå·¥å¤„ç†
```

---

## ğŸ“Š å®ç°ç»†èŠ‚

### ç«¯å£æ£€æŸ¥æµç¨‹

```
1. is_port_in_use(port)
   â””â”€ socket.connect_ex() â”€> ç«‹å³è¿”å›

2. get_process_using_port(port)  [ä»…å½“è¢«å ç”¨]
   â”œâ”€ lsof -i :8000 (ä¼˜å…ˆ)
   â””â”€ netstat (å›é€€)

3. IS_DEVELOPMENT?
   â”œâ”€ YES: kill_process(pid)
   â”‚   â”œâ”€ SIGTERM
   â”‚   â”œâ”€ wait 1s
   â”‚   â”œâ”€ SIGKILL if needed
   â”‚   â””â”€ verify freed
   â”‚
   â””â”€ NO: print error & exit

4. Start uvicorn
```

### è¶…æ—¶å’Œé‡è¯•

```python
# æ€æ­»è¿›ç¨‹çš„è¶…æ—¶
AUTO_KILL_TIMEOUT = 5  # ç§’

# éªŒè¯é‡Šæ”¾çš„ç­‰å¾…æ—¶é—´
CLEANUP_SLEEP = 2      # ç§’

# æ— é‡è¯•é€»è¾‘ï¼ˆç®€æ´è®¾è®¡ï¼‰
# æ€ä¸æ­»å°±å¤±è´¥ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å¤„ç†
```

---

## ğŸ“ ç”¨æˆ·ä½“éªŒ

### åœºæ™¯ 1: å¼€å‘ï¼Œé¦–æ¬¡å¯åŠ¨ï¼ˆç«¯å£ç©ºé—²ï¼‰

```bash
$ python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

2025-11-25 11:25:00 - INFO - âœ… Port 8000 is available
2025-11-25 11:25:00 - INFO - âœ… Starting server on 0.0.0.0:8000

INFO:     Started server process [38001]
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**ç”¨æˆ·æ„Ÿå—**: æ— æ„Ÿï¼Œä¸€åˆ‡æ­£å¸¸ âœ…

### åœºæ™¯ 2: å¼€å‘ï¼Œé‡å¯ï¼ˆç«¯å£è¢«å ç”¨ï¼‰

```bash
$ python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

2025-11-25 11:25:00 - WARNING - âš ï¸  Port 8000 is already in use
2025-11-25 11:25:00 - INFO - ğŸ’¡ Development environment detected
2025-11-25 11:25:00 - INFO - Attempting to free up port...
2025-11-25 11:25:00 - INFO - Process using port: 36237
2025-11-25 11:25:01 - INFO - âœ… Successfully killed process 36237
2025-11-25 11:25:03 - INFO - âœ… Port 8000 is now available
2025-11-25 11:25:03 - INFO - âœ… Starting server on 0.0.0.0:8000

INFO:     Started server process [38001]
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**ç”¨æˆ·æ„Ÿå—**: çœ‹åˆ°è‡ªåŠ¨æ¸…ç†ï¼Œç»§ç»­å·¥ä½œ âœ…

### åœºæ™¯ 3: ç”Ÿäº§ï¼Œç«¯å£è¢«å ç”¨

```bash
$ export ENVIRONMENT=production
$ python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

2025-11-25 11:25:00 - WARNING - âš ï¸  Port 8000 is already in use
2025-11-25 11:25:00 - ERROR - ğŸš¨ Port conflict in PRODUCTION environment!
2025-11-25 11:25:00 - ERROR - Port 8000 is already in use
2025-11-25 11:25:00 - ERROR -
2025-11-25 11:25:00 - ERROR - âš ï¸  IMPORTANT: Do NOT auto-kill processes in production!
2025-11-25 11:25:00 - ERROR -
2025-11-25 11:25:00 - ERROR - Please:
2025-11-25 11:25:00 - ERROR -   1. Find the process: lsof -i :8000
2025-11-25 11:25:00 - ERROR -   2. Investigate if it should be running
2025-11-25 11:25:00 - ERROR -   3. Kill manually if safe: kill -9 <PID>
2025-11-25 11:25:00 - ERROR -   4. Or use a different port: --port 8001
2025-11-25 11:25:00 - ERROR - âŒ Cannot start: port is not available
```

**ç”¨æˆ·æ„Ÿå—**: æ¸…æ¥šçš„é”™è¯¯ä¿¡æ¯å’Œæ•…éšœæ’æŸ¥æ­¥éª¤ âš ï¸

---

## ğŸ”§ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|
| socket | ç«¯å£æ£€æµ‹ | å¿«é€Ÿã€å¯é  |
| subprocess | å‘½ä»¤æ‰§è¡Œ | å…¼å®¹ Linux/Mac |
| lsof/netstat | PID è·å– | æ ‡å‡†å·¥å…· |
| signal | è¿›ç¨‹ç®¡ç† | POSIX æ ‡å‡† |
| os | ç³»ç»Ÿè°ƒç”¨ | Python åŸç”Ÿ |

---

## ğŸ“ˆ æ‰©å±•å¯èƒ½æ€§

### æœªæ¥å¢å¼º

1. **å¤šç«¯å£æ”¯æŒ**
   ```python
   ensure_port_available([8000, 8001, 8002])
   ```

2. **Graceful é‡å¯**
   ```python
   graceful_restart(port)  # ä¼˜é›…é‡å¯
   ```

3. **ç›‘æ§å’Œå‘Šè­¦**
   ```python
   log_port_conflict(port, old_pid, new_pid)
   alert_ops_team(incident)
   ```

4. **Windows æ”¯æŒ**
   ```python
   # å½“å‰ï¼šLinux/Mac only
   # æœªæ¥ï¼šnetstat for Windows
   ```

---

## âœ… éªŒæ”¶æ ‡å‡†

- âœ… å¼€å‘ç¯å¢ƒè‡ªåŠ¨æ¸…ç†å ç”¨ç«¯å£
- âœ… ç”Ÿäº§ç¯å¢ƒæ‹’ç»è‡ªåŠ¨æ“ä½œï¼ŒæŠ¥é”™é€€å‡º
- âœ… æ— éœ€æ”¹å˜ç”¨æˆ·å¯åŠ¨æ–¹å¼
- âœ… é›†æˆåˆ° main.pyï¼Œè‡ªåŠ¨æ‰§è¡Œ
- âœ… æ¸…æ™°çš„æ—¥å¿—è¾“å‡º
- âœ… å®Œæ•´çš„æ•…éšœæ’æŸ¥ä¿¡æ¯
- âœ… æ–‡æ¡£é½å…¨

---

## ğŸ“š æ–‡ä»¶æ¸…å•

```
src/infrastructure/port_manager.py
  â”œâ”€ PortManager ç±» (192 è¡Œ)
  â””â”€ ensure_port_available() å‡½æ•°

src/main.py
  â”œâ”€ å¯¼å…¥ PortManager (line 346)
  â”œâ”€ è°ƒç”¨æ£€æŸ¥ (line 353)
  â””â”€ å¯åŠ¨é€»è¾‘ (line 359)

PORT_MANAGEMENT_GUIDE.md
  â”œâ”€ å®Œæ•´ä½¿ç”¨æŒ‡å—
  â”œâ”€ æ—¥å¿—ç¤ºä¾‹
  â”œâ”€ æ•…éšœæ’æŸ¥
  â””â”€ æœ€ä½³å®è·µ

SMART_PORT_MANAGEMENT_DESIGN.md
  â”œâ”€ è®¾è®¡æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
  â”œâ”€ æ–¹æ¡ˆå¯¹æ¯”
  â”œâ”€ æ¶æ„è®¾è®¡
  â””â”€ æŠ€æœ¯è¯´æ˜
```

---

## ğŸ“ å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | ç†ç”± |
|------|------|
| é›†æˆåˆ° main.py | è‡ªåŠ¨æ‰§è¡Œï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ |
| ç¯å¢ƒå˜é‡æ§åˆ¶ | å®‰å…¨åŒºåˆ†å¼€å‘/ç”Ÿäº§ |
| ä»…æ€æ­»å ç”¨è¿›ç¨‹ | æœ€å°åŒ–å½±å“èŒƒå›´ |
| SIGTERM ä¼˜å…ˆ | å…è®¸è¿›ç¨‹ä¼˜é›…å…³é—­ |
| è¶…æ—¶æœºåˆ¶ | é˜²æ­¢æ— é™ç­‰å¾… |
| æ¸…æ™°çš„æ—¥å¿— | ä¾¿äºè°ƒè¯•å’Œå®¡è®¡ |

---

## ğŸ“Š æœ€ç»ˆè¯„ä¼°

### æ•ˆæœ

| ç›®æ ‡ | å®ç° | è¯„åˆ† |
|------|------|------|
| è§£å†³è‡ªåŠ¨å…³é—­é—®é¢˜ | âœ… å¼€å‘è‡ªåŠ¨å¤„ç† | 10/10 |
| ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ€§ | âœ… æ‹’ç»è‡ªåŠ¨æ“ä½œ | 10/10 |
| ç”¨æˆ·ä½“éªŒ | âœ… é€æ˜è‡ªåŠ¨åŒ– | 10/10 |
| å¯ç»´æŠ¤æ€§ | âœ… æ¨¡å—åŒ–è®¾è®¡ | 9/10 |
| æ–‡æ¡£å®Œæ•´æ€§ | âœ… è¯¦ç»†æŒ‡å— | 10/10 |

### æ€»ä½“è¯„ä¼°: **9.8/10** âœ…

**ç»“è®º**: è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§å°±ç»ª**çš„æ™ºèƒ½ç«¯å£ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ—¢è§£å†³äº†å¼€å‘æ•ˆç‡é—®é¢˜ï¼Œåˆä¿è¯äº†ç”Ÿäº§ç¯å¢ƒå®‰å…¨ã€‚

---

**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œä»£ç å®ç°å®Œæˆï¼Œæµ‹è¯•å°±ç»ª
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·æµ‹è¯•ä¸åé¦ˆæ”¶é›†

