# å‰åç«¯æ•´åˆå¯åŠ¨è„šæœ¬æ¶æ„è®¾è®¡

**æ—¥æœŸ**: 2025-11-21
**çŠ¶æ€**: âœ… **æ¶æ„æ–¹æ¡ˆç¡®å®š**
**å†³ç­–**: ä½¿ç”¨ Supervisord + Python ç›‘æ§çš„ç”Ÿäº§çº§æ–¹æ¡ˆ

---

## ğŸ“‹ æ–¹æ¡ˆå¯¹æ¯”ä¸æœ€ç»ˆå†³ç­–

### è¯„ä¼°è¡¨

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨è |
|------|---------|------|------|------|
| **Supervisord** âœ… | ç”Ÿäº§ç¯å¢ƒ | æˆç†Ÿç¨³å®šã€è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç»Ÿä¸€ã€äº‹ä»¶ç›‘å¬ | éœ€è¦é…ç½® | â­â­â­â­â­ |
| Docker Compose | æœ¬åœ°å¼€å‘ | éš”ç¦»æ€§å¥½ã€ç®€å•å¿«é€Ÿ | Coolifyå·²æœ‰å®¹å™¨ | â­â­â­ |
| PM2 | Node.jsé¡¹ç›® | Node.jså‹å¥½ | Pythonæ”¯æŒå¼± | â­â­ |
| çº¯Bash | ä¸´æ—¶æ–¹æ¡ˆ | ç®€å• | ä¸å¤Ÿå¥å£® | â­ |
| S6-overlay | Alpineå®¹å™¨ | è½»é‡ | å­¦ä¹ æ›²çº¿é™¡ | â­â­ |

### æœ€ç»ˆå†³ç­–

âœ… **ä½¿ç”¨ Supervisor + Python ç›‘æ§è„šæœ¬**

**ç†ç”±**:
1. **æˆç†Ÿå¯é ** - 15+ å¹´å†å²ï¼Œæ•°åä¸‡ç”Ÿäº§ç¯å¢ƒåº”ç”¨
2. **åŸç”Ÿæ”¯æŒ** - è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†ã€è¿›ç¨‹ç›‘æ§
3. **ä¸æŠ€æœ¯æ ˆä¸€è‡´** - Pythonç›‘æ§è„šæœ¬ä¸åç«¯æŠ€æœ¯æ ˆåŒ¹é…
4. **Dockerå‹å¥½** - æ˜“äºåœ¨å®¹å™¨ä¸­è¿è¡Œï¼ŒCoolifyå®Œç¾æ”¯æŒ
5. **å®Œæ•´åŠŸèƒ½** - ç›‘æ§ã€å‘Šè­¦ã€è‡ªåŠ¨æ¢å¤ã€ä¼˜é›…å…³é—­

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Coolify Container (ç”Ÿäº§ç¯å¢ƒ)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PID 1: /docker-entrypoint.sh                            â”‚
â”‚         â””â”€ supervisord (ä¸»è¿›ç¨‹)                           â”‚
â”‚            â”‚                                              â”‚
â”‚            â”œâ”€ [program:backend]                           â”‚
â”‚            â”‚  â””â”€ python -m uvicorn src.main:app          â”‚
â”‚            â”‚     Port: 8000                               â”‚
â”‚            â”‚     autostart: true                          â”‚
â”‚            â”‚     autorestart: true                        â”‚
â”‚            â”‚     Priority: 100                            â”‚
â”‚            â”‚                                              â”‚
â”‚            â”œâ”€ [program:frontend]                          â”‚
â”‚            â”‚  â””â”€ npm run start (Nginx serve)             â”‚
â”‚            â”‚     Port: 3000                               â”‚
â”‚            â”‚     autostart: true                          â”‚
â”‚            â”‚     autorestart: true                        â”‚
â”‚            â”‚     Priority: 200 (ç­‰å¾…åç«¯å¯åŠ¨)             â”‚
â”‚            â”‚                                              â”‚
â”‚            â””â”€ [program:healthcheck]                       â”‚
â”‚               â””â”€ python scripts/monitor/health_monitor.py â”‚
â”‚                  autostart: true                          â”‚
â”‚                  Priority: 300 (æœ€åå¯åŠ¨)                 â”‚
â”‚                                                           â”‚
â”‚  [eventlistener:crash_notifier]                          â”‚
â”‚  â””â”€ Webhookå‘Šè­¦ (å¯é€‰Slack/Discord)                      â”‚
â”‚                                                           â”‚
â”‚  Logs: /var/log/supervisor/ + /app/logs/                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ (ä¾èµ–)
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL (å¤–éƒ¨)       â”‚
        â”‚  47.79.87.199:5432       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. Supervisord é…ç½® (è¿›ç¨‹ç®¡ç†)

**ç›®çš„**: ç»Ÿä¸€ç®¡ç†å‰åç«¯è¿›ç¨‹ï¼Œè‡ªåŠ¨é‡å¯å¤±è´¥æœåŠ¡

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… è‡ªåŠ¨å¯åŠ¨å’Œé‡å¯
- âœ… å¯åŠ¨é¡ºåºæ§åˆ¶ (priority)
- âœ… æ—¥å¿—èšåˆå’Œè½®è½¬
- âœ… äº‹ä»¶ç›‘å¬ (å´©æºƒå‘Šè­¦)
- âœ… ä¼˜é›…å…³é—­
- âœ… CPU/å†…å­˜é™åˆ¶

### 2. å¥åº·ç›‘æ§è„šæœ¬ (Python)

**ç›®çš„**: å®šæœŸæ£€æŸ¥ä¸¤ä¸ªæœåŠ¡çš„å¯ç”¨æ€§ï¼Œå¤±è´¥æ—¶é€šçŸ¥Supervisoré‡å¯

**ç›‘æ§å†…å®¹**:
- åç«¯ HTTP å¥åº·æ£€æŸ¥ (`GET /health`)
- å‰ç«¯ HTTP å¯è®¿é—®æ€§ (`GET /`)
- å¤±è´¥é˜ˆå€¼å’Œé‡è¯•ç­–ç•¥
- èµ„æºä½¿ç”¨ç›‘æ§ (CPU, å†…å­˜)
- å‘Šè­¦é€šçŸ¥ (Webhook)

### 3. Docker é•œåƒ (Dockerfile)

**ç›®çš„**: å°†æ•´ä¸ªåº”ç”¨æ‰“åŒ…ï¼ŒåŒ…æ‹¬å‰åç«¯å’ŒSupervisor

**åŒ…å«å†…å®¹**:
- Python 3.12 è¿è¡Œæ—¶
- Node.js è¿è¡Œæ—¶
- Supervisor è¿›ç¨‹ç®¡ç†
- Nginx (å‰ç«¯æœåŠ¡)
- å¥åº·æ£€æŸ¥é…ç½®

### 4. Coolify é…ç½®

**ç›®çš„**: åœ¨Coolifyä¸­è¿è¡Œå®¹å™¨ï¼Œé…ç½®è‡ªåŠ¨é‡å¯å’Œç›‘æ§

**é…ç½®é¡¹**:
- å®¹å™¨é•œåƒæº (GHCR)
- ç¯å¢ƒå˜é‡
- èµ„æºé™åˆ¶
- å¥åº·æ£€æŸ¥
- å‘Šè­¦è§„åˆ™

---

## ğŸ”„ å¯åŠ¨æµç¨‹

```
1. Docker å®¹å™¨å¯åŠ¨
   â†“
2. Entrypoint æ‰§è¡Œ
   â”œâ”€ æ£€æŸ¥æ•°æ®åº“è¿æ¥
   â””â”€ å¯åŠ¨ supervisord
   â†“
3. Supervisord å¯åŠ¨ç¨‹åº (æŒ‰ priority é¡ºåº)
   â”œâ”€ Priority 100: Backend (FastAPI)
   â”‚  â””â”€ ç­‰å¾…å°±ç»ª (5-10ç§’)
   â”‚
   â”œâ”€ Priority 200: Frontend (Nginx)
   â”‚  â””â”€ ç­‰å¾…å¯åŠ¨ (3-5ç§’)
   â”‚
   â””â”€ Priority 300: HealthCheck (ç›‘æ§è„šæœ¬)
      â””â”€ å¼€å§‹å®šæœŸæ£€æŸ¥
   â†“
4. åº”ç”¨å°±ç»ªï¼Œæ¥å—æµé‡
   â†“
5. ç›‘æ§å¾ªç¯ (æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡)
   â”œâ”€ æ£€æŸ¥åç«¯å¥åº·
   â”œâ”€ æ£€æŸ¥å‰ç«¯å¯ç”¨æ€§
   â””â”€ å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯
```

---

## ğŸ’» å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒ (æœ¬åœ°)

```bash
# ç®€åŒ–çš„å¯åŠ¨è„šæœ¬ (scripts/dev-start.sh)
#!/bin/bash

# å¯åŠ¨åç«¯
cd /app
source .venv/bin/activate
python -m uvicorn src.main:app --reload --port 8000 &

# ç­‰å¾…åç«¯å°±ç»ª
until curl -sf http://localhost:8000/health; do sleep 2; done

# å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

**ä¼˜ç‚¹**: ç®€å•å¿«é€Ÿï¼Œå¼€å‘å‹å¥½
**ç”¨é€”**: æœ¬åœ°å¼€å‘ã€å¿«é€Ÿè¿­ä»£

### ç”Ÿäº§ç¯å¢ƒ (Coolify)

```dockerfile
# Dockerfile (å¤šé˜¶æ®µæ„å»º)
FROM python:3.12-slim AS builder
# ... æ„å»ºä¾èµ–

FROM node:20 AS frontend-builder
# ... æ„å»ºå‰ç«¯

FROM python:3.12-slim
# ... ç”Ÿäº§é•œåƒ
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
```

**ä¼˜ç‚¹**: å®Œæ•´ç›‘æ§ã€è‡ªåŠ¨é‡å¯ã€å‘Šè­¦é€šçŸ¥
**ç”¨é€”**: ç”Ÿäº§éƒ¨ç½²ã€ç¨³å®šè¿è¡Œ

---

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

| ç«¯ç‚¹ | ç”¨é€” | å“åº”æ—¶é—´ |
|------|------|---------|
| `GET /health` | æ´»æ€§æ£€æŸ¥ (Liveness) | <100ms |
| `GET /ready` | å°±ç»ªæ£€æŸ¥ (Readiness) | <2s |
| `GET /metrics` | Prometheus æŒ‡æ ‡ | <1s |

### ç›‘æ§æŒ‡æ ‡

```yaml
# åç«¯ç›‘æ§
- cpu_usage: CPU ä½¿ç”¨ç‡
- memory_usage: å†…å­˜ä½¿ç”¨ç‡
- request_latency: è¯·æ±‚å»¶è¿Ÿ
- error_rate: é”™è¯¯ç‡
- db_connection_pool: è¿æ¥æ± çŠ¶æ€

# å‰ç«¯ç›‘æ§
- response_time: å“åº”æ—¶é—´
- status_code: HTTP çŠ¶æ€ç 
- uptime: è¿è¡Œæ—¶é—´

# ç³»ç»Ÿç›‘æ§
- disk_usage: ç£ç›˜ä½¿ç”¨ç‡
- restart_count: é‡å¯æ¬¡æ•°
- last_restart_time: æœ€åé‡å¯æ—¶é—´
```

### å‘Šè­¦è§„åˆ™

| å‘Šè­¦ | æ¡ä»¶ | åŠ¨ä½œ |
|------|------|------|
| Service Down | è¿ç»­ 3 æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥ | è‡ªåŠ¨é‡å¯ + Webhook |
| High CPU | CPU > 80% æŒç»­ 5 åˆ†é’Ÿ | Webhook |
| High Memory | å†…å­˜ > 85% æŒç»­ 5 åˆ†é’Ÿ | Webhook + å¯é€‰æ‰©å®¹ |
| Too Many Restarts | 1å°æ—¶å†…é‡å¯ > 5æ¬¡ | å‘Šè­¦ + é¡µé¢å‘ŠçŸ¥ |

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### Step 1: æœ¬åœ°æµ‹è¯•

```bash
# æ„å»ºé•œåƒ
docker build -f Dockerfile -t myapp:latest .

# æœ¬åœ°æµ‹è¯•
docker run -p 3000:3000 -p 8000:8000 \
  -e DATABASE_URL=postgresql://... \
  myapp:latest

# éªŒè¯
curl http://localhost:8000/health
curl http://localhost:3000
```

### Step 2: æ¨é€åˆ° GHCR

```bash
docker tag myapp:latest ghcr.io/datalablife/myapp:latest
docker push ghcr.io/datalablife/myapp:latest
```

### Step 3: Coolify éƒ¨ç½²

1. åœ¨ Coolify ä¸­æ–°å»ºåº”ç”¨æˆ–æ›´æ–°ç°æœ‰åº”ç”¨
2. é…ç½®é•œåƒæº: `ghcr.io/datalablife/myapp:latest`
3. é…ç½®ç¯å¢ƒå˜é‡
4. é…ç½®å¥åº·æ£€æŸ¥: `http://localhost:8000/health`
5. é…ç½®é‡å¯ç­–ç•¥: `unless-stopped`
6. éƒ¨ç½²

### Step 4: éªŒè¯

```bash
# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker logs <container-id>

# æ£€æŸ¥ç›‘æ§è„šæœ¬è¾“å‡º
docker exec <container-id> tail -f /var/log/app/health.log

# è®¿é—®åº”ç”¨
curl https://jackcwf.com
curl https://jackcwf.com/health
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä½ç½® | ç”¨é€” |
|------|------|------|
| `supervisord.conf` | `/etc/supervisor/conf.d/` | è¿›ç¨‹ç®¡ç†é…ç½® |
| `health_monitor.py` | `scripts/monitor/` | å¥åº·æ£€æŸ¥è„šæœ¬ |
| `docker-entrypoint.sh` | `/` | Docker å…¥å£è„šæœ¬ |
| `Dockerfile` | `/` | Docker é•œåƒå®šä¹‰ |
| `docker-compose.yml` | `/` | Coolify å®¹å™¨é…ç½® |
| `nginx.conf` | `/` | Nginx å‰ç«¯æœåŠ¡é…ç½® |

---

## ğŸ“ˆ å¯é æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®ç°æ–¹å¼ |
|------|------|---------|
| å¯ç”¨æ€§ | 99.9% | è‡ªåŠ¨é‡å¯ + å¥åº·æ£€æŸ¥ |
| æ•…éšœè½¬ç§» | < 2 åˆ†é’Ÿ | 30s æ£€æŸ¥ + ç«‹å³é‡å¯ |
| æ—¥å¿—ä¿ç•™ | 7 å¤© | æ—¥å¿—è½®è½¬ + å¤–éƒ¨å­˜å‚¨ |
| å‘Šè­¦å»¶è¿Ÿ | < 1 åˆ†é’Ÿ | å®æ—¶ç›‘æ§ + Webhook |

---

## âœ… å…³é”®å†³ç­–æ€»ç»“

### å·²ç¡®å®š

âœ… **è¿›ç¨‹ç®¡ç†**: Supervisord
âœ… **ç›‘æ§æ–¹å¼**: Python è„šæœ¬å®šæœŸæ£€æŸ¥
âœ… **å®¹å™¨è¿è¡Œæ—¶**: Docker + Coolify
âœ… **æ—¥å¿—ç®¡ç†**: ç»Ÿä¸€åˆ° /app/logs/ + /var/log/
âœ… **æ•…éšœæ¢å¤**: è‡ªåŠ¨é‡å¯ + 3 æ¬¡é‡è¯•æœºåˆ¶
âœ… **å¥åº·æ£€æŸ¥**: HTTP ç«¯ç‚¹ + è¶…æ—¶æ§åˆ¶
âœ… **å‘Šè­¦é€šçŸ¥**: Webhook (å¯é…ç½® Slack/Discord)

### å¾…å®ç°

â³ **Dockerfile** - å¤šé˜¶æ®µæ„å»ºï¼ŒåŒ…å« Supervisor
â³ **supervisord.conf** - å®Œæ•´çš„è¿›ç¨‹é…ç½®
â³ **health_monitor.py** - Python ç›‘æ§è„šæœ¬
â³ **docker-entrypoint.sh** - å®¹å™¨å¯åŠ¨è„šæœ¬
â³ **ç¯å¢ƒå˜é‡é…ç½®** - Coolify ç¯å¢ƒè®¾ç½®

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### Immediate (ä»Šå¤©)

1. **åˆ›å»º Dockerfile** - æ”¯æŒ Supervisor çš„å¤šè¯­è¨€é•œåƒ
2. **åˆ›å»º supervisord.conf** - é…ç½®åç«¯ã€å‰ç«¯ã€ç›‘æ§
3. **åˆ›å»ºå¥åº·ç›‘æ§è„šæœ¬** - Python ç‰ˆæœ¬
4. **æµ‹è¯•æœ¬åœ°æ„å»ºå’Œè¿è¡Œ**

### éƒ¨ç½²å‰ (Day 2)

5. **é…ç½® GitHub Secrets** - æ•°æ®åº“ã€APIå¯†é’¥ç­‰
6. **æœ¬åœ°æµ‹è¯•å®Œæ•´æµç¨‹** - Docker é•œåƒæ„å»ºã€è¿è¡Œã€ç›‘æ§
7. **éªŒè¯ç›‘æ§å‘Šè­¦** - æ‰‹åŠ¨åœæ­¢æœåŠ¡ï¼Œè§‚å¯Ÿè‡ªåŠ¨é‡å¯

### éƒ¨ç½²åˆ° Coolify (Day 2-3)

8. **åœ¨ Coolify åˆ›å»º/æ›´æ–°åº”ç”¨** - é…ç½®é•œåƒæº
9. **éƒ¨ç½²åˆ° Development** - éªŒè¯åŠŸèƒ½
10. **éƒ¨ç½²åˆ° Staging** - å®Œæ•´æµ‹è¯•
11. **éƒ¨ç½²åˆ° Production** - å¯ç”¨å‘Šè­¦

---

## ğŸ“š å‚è€ƒèµ„æº

- [Supervisor å®˜æ–¹æ–‡æ¡£](http://supervisord.org/)
- [FastAPI å¥åº·æ£€æŸ¥](https://fastapi.tiangolo.com/deployment/concepts/)
- [Docker æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
- [Coolify æ–‡æ¡£](https://coolify.io/docs)

---

## ğŸ“ æ¶æ„ä¼˜åŠ¿

1. **å¯é æ€§** - Supervisor è‡ªåŠ¨é‡å¯ç¡®ä¿æœåŠ¡æŒç»­è¿è¡Œ
2. **å¯è§‚å¯Ÿæ€§** - ç»Ÿä¸€çš„æ—¥å¿—ã€ç›‘æ§ã€å‘Šè­¦
3. **å¯ç»´æŠ¤æ€§** - é…ç½®æ–‡ä»¶æ¸…æ™°ï¼Œæ˜“äºä¿®æ”¹å’Œæ‰©å±•
4. **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ›´å¤šæœåŠ¡å’Œç›‘æ§è§„åˆ™
5. **æˆæœ¬æ•ˆç›Š** - åˆ©ç”¨å·²æœ‰åŸºç¡€è®¾æ–½ï¼Œæ— é¢å¤–æˆæœ¬

---

**å†³ç­–ç¡®è®¤æ—¥æœŸ**: 2025-11-21
**æ¶æ„è®¾è®¡**: ç”Ÿäº§çº§ Supervisor + Python ç›‘æ§
**éƒ¨ç½²ç›®æ ‡**: Coolify å®¹å™¨åŒ– + GitHub Actions CI/CD

