# 4GB 内存生产环境 - 快速决策指南

## 🎯 一句话总结

**跳过 ELK，部署 Redis + Prometheus + Grafana 的轻量版本。**
- ✅ 内存占用: 3.2GB（安全）
- ✅ 性能提升: 60%（通过 Redis 缓存）
- ✅ 月成本节省: 50%

---

## 📋 立即行动清单

### 第 1 步：跳过以下组件（节省 1.5GB）❌

```
不要部署：
❌ Elasticsearch (1-2GB)
❌ Logstash (256-512MB)
❌ Kibana (256-512MB)
❌ 完整的 ELK 栈

替代方案：使用 Coolify 内置日志功能（免费、无内存占用）
```

### 第 2 步：优先部署这些（节省内存，性能最优）✅

```
必需部署：
✅ PostgreSQL （调整配置，仅 500-800MB）
✅ FastAPI 后端 （200-300MB）
✅ Redis 缓存 （256MB，可带来 60% 性能提升）
✅ Prometheus （150MB，轻量级监控）
✅ Grafana （100MB，仪表板）

总计：3.2GB（在 4GB 内存内安全运行）
```

### 第 3 步：关键配置调整

**PostgreSQL 内存配置**（必做，否则会吃完你的内存）：

```ini
# 编辑 PostgreSQL 配置（Coolify 中通过环境变量设置）
shared_buffers = 256MB        # 重要：仅 25% RAM
effective_cache_size = 1GB    # 重要：仅 25% RAM
work_mem = 8MB
maintenance_work_mem = 64MB
max_connections = 50          # 降低连接数（默认 100）
```

**Redis 配置**（已包含在之前的指南中）：

```env
REDIS_MAX_MEMORY=256mb
REDIS_MAXMEMORY_POLICY=allkeys-lru
CACHE_TTL_CONVERSATION=1800   # 改为 30 分钟（不是 1 小时）
```

---

## ⚡ 性能对比

### 对比不同方案

| 方案 | 内存占用 | 性能 | 可观测性 | 成本 |
|------|---------|------|---------|------|
| **推荐：轻量版** | **3.2GB** | **良好** | **完整** | **¥400/月** |
| 完整版（需8GB+） | 5.5GB+ | 最优 | 完整 | ¥800/月 |
| 最小化（仅DB）| 1.5GB | 差 | 无 | ¥200/月 |

---

## 📊 预期性能指标（4GB）

使用轻量版方案后，你可以期待：

```
缓存命中率:     50-70% （通过 Redis）
平均延迟:       60ms  （对比 150ms，改进 60%）
数据库查询:     10-100x 更快 （通过优化）
内存使用:       3.2GB （安全，不会 OOM）
告警覆盖:       10 个关键告警 （足够）
```

### 与完整部署的差异

- **缓存命中率**: 50-70% vs 70-80% （-10-20%）
- **延迟**: 60ms vs 40ms （+20ms，用户感知不到）
- **吞吐量**: 300 req/s vs 500 req/s （仍然足够中等流量）

---

## ❌ 不要做的事

### 千万不要在 4GB 服务器上做这些

```
❌ 部署完整的 ELK（会导致频繁 OOM）
❌ 使用默认的 PostgreSQL 配置（会吃光内存）
❌ 部署多个监控组件（Prometheus + Grafana 就够了）
❌ 设置太大的 Redis 缓存（256MB 是上限）
❌ 同时运行很多容器（保持 5-6 个左右）
```

---

## 🚀 分阶段实施计划

### Week 1（3-4 天）

**Day 1-2**：核心优化（无需新部署）
- [ ] 调整 PostgreSQL 内存配置
- [ ] 应用数据库查询优化（eager loading）
- [ ] 添加数据库索引
- **成本**: 0 元，**内存节省**: -200MB

**Day 3-4**：部署 Redis
- [ ] 部署 Redis（256MB）
- [ ] 集成 Redis 到应用（src/main.py）
- [ ] 启用 cache middleware
- **成本**: +256MB 内存，**性能收益**: 60% 延迟降低

### Week 2（2-3 天）

**Day 1-2**：轻量级监控
- [ ] 部署 Prometheus（轻量版，150MB）
- [ ] 部署 Grafana（100MB）
- [ ] 配置 10 个关键告警
- **成本**: +250MB 内存，**收益**: 完整的可观测性

**Day 3**：测试和验证
- [ ] 负载测试
- [ ] 验证内存占用 < 3.5GB
- [ ] 测试告警通知

---

## 💾 部署后的内存断面

```
启动后的内存占用：

$ free -h
              total   used  free  shared  buff/cache  available
Mem:           4.0G   3.2G  0.3G   0.1G       0.5G      0.5G

分解：
Linux kernel ......... 300MB
FastAPI 后端 ......... 250MB
PostgreSQL ........... 750MB  ← 通过调整配置减少这个
Redis ................ 256MB
Prometheus ........... 150MB
Grafana .............. 100MB
系统缓存 ............. 400MB
可用 ................. 300MB  ← 保持 >200MB 很重要

✅ 安全范围：内存使用 75-80%
⚠️ 警告范围：内存使用 90%+
❌ 危险范围：内存使用 95%+（容易 OOM）
```

---

## 📈 监控关键指标

在 4GB 内存下，特别关注这些指标：

```yaml
# Prometheus alerts-4gb.yml

关键告警：
1. 内存使用 > 3.2GB （应该不会发生）
2. PostgreSQL 连接数 > 80 （会导致内存溢出）
3. Redis 内存使用 > 256MB （需要清理）
4. API 延迟 P95 > 2s （表示资源紧张）
5. 缓存命中率 < 30% （Redis 配置有问题）
6. 数据库查询 > 1s （需要优化查询）
7. 磁盘 swap 使用 > 100MB （严重警告：内存压力大）
8. 容器重启 > 0 （表示 OOM kill）
9. 文件描述符使用 > 80% （连接泄漏）
10. 待处理任务 > 1000 （队列堆积）
```

---

## 🔧 故障排除

### 症状 1：内存使用逐渐增加

```bash
# 检查是否有内存泄漏
docker stats

# 解决方案
- 增加 Redis 过期时间（TTL）
- 减少 PostgreSQL 连接池大小
- 重启容器（临时方案）
```

### 症状 2：服务间歇性崩溃（OOM Kill）

```bash
# 检查日志
dmesg | grep "OOM killer"
docker logs <container> | grep "Killed"

# 解决方案
- 减少 Redis 最大内存（从 256MB 到 128MB）
- 调整 PostgreSQL shared_buffers （从 256MB 到 128MB）
- 禁用 Grafana（如果不关键）
```

### 症状 3：性能突然下降（SWAP）

```bash
# 检查 swap 使用
free -h
vmstat 1 5

# 如果看到 swap 增加，说明内存不足
# 解决方案：立即增加服务器内存或禁用某些功能
```

---

## 📞 何时升级内存

如果遇到以下情况，考虑升级到 8GB：

1. **缓存命中率持续 < 40%**
   - 说明 Redis 太小
   - 升级后可将 Redis 增加到 512MB

2. **API 延迟 P95 > 2s**
   - 说明处理能力不足
   - 升级后可运行更多服务

3. **频繁出现 OOM Kill**
   - 容器莫名崩溃
   - 应该升级

4. **你的用户数增加 2x**
   - 更多并发连接
   - 需要更多缓存空间

---

## 成本对比

### 月成本变化

```
配置    内存  服务器成本/月  优化部署成本
2GB     2GB   ¥200         ¥50（失败）
4GB     4GB   ¥400         ¥200 ✅ 推荐
8GB     8GB   ¥800         ¥500（过度配置）
16GB    16GB  ¥1500        ¥1000（非常过度）
```

**推荐**: 4GB + 轻量级部署 = **¥400/月的最佳选择**

---

## 最终建议

### 对于 4GB 内存服务器

| 优化 | 行动 | 理由 |
|------|------|------|
| **Redis** | ✅ 必须 | 60% 性能提升，仅 256MB |
| **数据库优化** | ✅ 必须 | 0 额外成本，10-100x 快 |
| **Prometheus** | ✅ 推荐 | 150MB，关键监控 |
| **Grafana** | ✅ 推荐 | 100MB，可视化 |
| **ELK** | ❌ 跳过 | 1.5GB 太多，用云服务 |

### 部署顺序

```
优先级 1: PostgreSQL 配置优化 → Redis 部署（Week 1）
优先级 2: 数据库查询优化 → Prometheus（Week 2）
优先级 3: Grafana 仪表板 → 性能测试（Week 2）
```

### 成果

```
✅ 内存占用：3.2GB（安全）
✅ 性能提升：60%（通过缓存）
✅ 月成本：¥400（节省 50%）
✅ 可观测性：10 个关键告警 + Grafana 仪表板
✅ 可扩展性：支持到 5000+ 日活用户
```

---

**结论**：4GB 内存完全足够，只需要聪明地部署，**跳过 ELK，优先 Redis + Prometheus**。

