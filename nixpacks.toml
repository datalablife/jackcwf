# Nixpacks configuration for Reflex 0.8.16 application
# Optimized for Coolify deployment with proper build phases

# Setup phase - install system dependencies
# unzip is required by Reflex for installing Bun (JavaScript runtime)
[phases.setup]
nixPkgs = ["python312", "nodejs_20", "curl", "git", "unzip"]

# Install phase - Python dependencies
[phases.install]
cmds = [
    # Install uv package manager
    "curl -LsSf https://astral.sh/uv/install.sh | sh",
    "export PATH=\"$HOME/.cargo/bin:$PATH\"",
    # Install Python dependencies (production only)
    "uv sync --no-dev"
]

# Build phase - compile Reflex frontend
[phases.build]
cmds = [
    # Activate virtual environment
    "export PATH=\".venv/bin:$PATH\"",
    # Initialize Reflex (creates .web directory structure)
    "python -m reflex init --loglevel warning",
    # Export frontend (compile React app)
    "python -m reflex export --frontend-only --loglevel info"
]

# Start command
[start]
cmd = "python -m reflex run --env production --loglevel info"

# Environment variables for production
[variables]
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
REFLEX_ENV = "production"
FRONTEND_PORT = "3000"
BACKEND_PORT = "8000"
