# Nixpacks configuration for Reflex 0.8.16 application
# Optimized for Coolify deployment with proper build phases

# Setup phase - install system dependencies
# unzip is required by Reflex for installing Bun (JavaScript runtime)
[phases.setup]
nixPkgs = ["python312", "nodejs_20", "curl", "git", "unzip", "bash"]

# Install phase - Python dependencies
[phases.install]
cmds = [
    # Create virtual environment
    "python -m venv .venv",
    # Activate and upgrade pip
    ". .venv/bin/activate && pip install --upgrade pip setuptools wheel",
    # Install Python dependencies from pyproject.toml or requirements.txt
    ". .venv/bin/activate && pip install -e . || pip install reflex granian fastapi pydantic uvicorn python-socketio python-engineio"
]

# Build phase - compile Reflex frontend
[phases.build]
cmds = [
    # Activate virtual environment in each RUN step
    # Initialize Reflex (creates .web directory structure)
    ". .venv/bin/activate && python -m reflex init --loglevel warning",
    # Export frontend (compile React app)
    ". .venv/bin/activate && python -m reflex export --frontend-only --loglevel info"
]

# Start command - Use startup script for proper environment setup
[start]
cmd = "bash /app/start.sh"

# Environment variables for production
[variables]
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
REFLEX_ENV = "production"
FRONTEND_PORT = "3000"
BACKEND_PORT = "8000"
# Ensure virtual environment binaries are in PATH
VIRTUAL_ENV = "/app/.venv"
PATH = "/app/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
