#!/bin/bash
# Coolify Deployment Script
# ä½¿ç”¨ Coolify CLI è¿›è¡Œåº”ç”¨éƒ¨ç½²å’Œé…ç½®

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "             Story 4.4 - Coolify Deployment Script"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# é…ç½®
CONTEXT="myapp"
APP_UUID="mg8c40oowo80o08o0gsw0gwc"  # çŽ°æœ‰åº”ç”¨ UUID
IMAGE_REPO="datalablife/jackcwf"
IMAGE_TAG="main-$(git rev-parse --short HEAD)"

echo ""
echo "ðŸ“‹ é…ç½®ä¿¡æ¯"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Coolify Context:    $CONTEXT"
echo "Application UUID:   $APP_UUID"
echo "Image Repository:   $IMAGE_REPO"
echo "Image Tag:          $IMAGE_TAG"
echo ""

# Step 1: éªŒè¯ Coolify CLI
echo "Step 1: éªŒè¯ Coolify CLI"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if ! command -v coolify &> /dev/null; then
    echo "âŒ Coolify CLI æœªå®‰è£…"
    exit 1
fi
echo "âœ… Coolify CLI å·²å®‰è£…"
echo ""

# Step 2: éªŒè¯ä¸Šä¸‹æ–‡
echo "Step 2: éªŒè¯ Coolify ä¸Šä¸‹æ–‡"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if coolify context list --context "$CONTEXT" &> /dev/null; then
    echo "âœ… ä¸Šä¸‹æ–‡ '$CONTEXT' å¯ç”¨"
else
    echo "âŒ ä¸Šä¸‹æ–‡ '$CONTEXT' ä¸å¯ç”¨"
    exit 1
fi
echo ""

# Step 3: æ˜¾ç¤ºçŽ°æœ‰åº”ç”¨ä¿¡æ¯
echo "Step 3: çŽ°æœ‰åº”ç”¨ä¿¡æ¯"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
APP_INFO=$(coolify app inspect "$APP_UUID" --context "$CONTEXT" 2>/dev/null || echo "")
if [ -z "$APP_INFO" ]; then
    echo "âš ï¸  æ— æ³•èŽ·å–åº”ç”¨è¯¦ç»†ä¿¡æ¯"
else
    echo "$APP_INFO" | head -20
fi
echo ""

# Step 4: éƒ¨ç½²é…ç½®æŒ‡å—
echo "Step 4: éƒ¨ç½²é…ç½®æŒ‡å—"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "ä»¥ä¸‹æ˜¯ä½¿ç”¨ Coolify CLI éƒ¨ç½²çš„æ­¥éª¤ï¼š"
echo ""
echo "1ï¸âƒ£  åœ¨ GitHub é…ç½® Secrets:"
echo "   - COOLIFY_API_TOKEN: ä»Ž Coolify èŽ·å– API Token"
echo "   - COOLIFY_FQDN: https://coolpanel.jackcwf.com"
echo "   - COOLIFY_APP_UUID: $APP_UUID"
echo ""
echo "2ï¸âƒ£  æ›´æ–°åº”ç”¨é…ç½®:"
echo "   coolify app update $APP_UUID \\"
echo "     --context $CONTEXT \\"
echo "     --image ghcr.io/$IMAGE_REPO:$IMAGE_TAG \\"
echo "     --git-branch main"
echo ""
echo "3ï¸âƒ£  è§¦å‘éƒ¨ç½²:"
echo "   coolify deploy trigger $APP_UUID --context $CONTEXT"
echo ""
echo "4ï¸âƒ£  æ£€æŸ¥éƒ¨ç½²çŠ¶æ€:"
echo "   coolify app status $APP_UUID --context $CONTEXT"
echo ""

# Step 5: æä¾›éƒ¨ç½²å‘½ä»¤æ¨¡æ¿
echo "Step 5: éƒ¨ç½²å‘½ä»¤å‚è€ƒ"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cat > deploy-commands.sh << 'EOF'
#!/bin/bash
# éƒ¨ç½²å‘½ä»¤å‚è€ƒ

APP_UUID="mg8c40oowo80o08o0gsw0gwc"
CONTEXT="myapp"
IMAGE="ghcr.io/datalablife/jackcwf:main-$(git rev-parse --short HEAD)"

# 1. æ›´æ–°åº”ç”¨é•œåƒ
echo "1ï¸âƒ£  æ›´æ–°åº”ç”¨é•œåƒ..."
coolify app update "$APP_UUID" \
  --context "$CONTEXT" \
  --image "$IMAGE" \
  --git-branch main

echo "âœ… åº”ç”¨å·²æ›´æ–°"

# 2. è§¦å‘éƒ¨ç½²
echo ""
echo "2ï¸âƒ£  è§¦å‘éƒ¨ç½²..."
coolify deploy trigger "$APP_UUID" --context "$CONTEXT"

echo "âœ… éƒ¨ç½²å·²è§¦å‘"

# 3. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
echo ""
echo "3ï¸âƒ£  æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
sleep 5
coolify app status "$APP_UUID" --context "$CONTEXT"

echo ""
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
EOF

chmod +x deploy-commands.sh
echo "âœ… éƒ¨ç½²å‘½ä»¤è„šæœ¬å·²ç”Ÿæˆ: deploy-commands.sh"
echo ""

# Step 6: æ˜¾ç¤ºéƒ¨ç½²åŽçš„éªŒè¯æ­¥éª¤
echo "Step 6: éƒ¨ç½²åŽéªŒè¯"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "éƒ¨ç½²å®ŒæˆåŽï¼Œè¯·è¿›è¡Œä»¥ä¸‹éªŒè¯:"
echo ""
echo "1ï¸âƒ£  æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€"
echo "   curl http://mg8c40oowo80o08o0gsw0gwc.47.79.87.199.sslip.io/health"
echo ""
echo "2ï¸âƒ£  æ£€æŸ¥å‰ç«¯æ˜¯å¦å¯è®¿é—®"
echo "   curl http://mg8c40oowo80o08o0gsw0gwc.47.79.87.199.sslip.io"
echo ""
echo "3ï¸âƒ£  æŸ¥çœ‹å®¹å™¨æ—¥å¿—"
echo "   coolify app logs $APP_UUID --context $CONTEXT --follow"
echo ""
echo "4ï¸âƒ£  ç›‘æŽ§éƒ¨ç½²çŠ¶æ€"
echo "   coolify app status $APP_UUID --context $CONTEXT"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "                 âœ… éƒ¨ç½²é…ç½®å·²å‡†å¤‡å®Œæˆï¼"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
