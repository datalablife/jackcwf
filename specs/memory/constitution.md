<!--
╔════════════════════════════════════════════════════════════════════════════╗
║          项目宪法 - 同步影响报告 (v1.0.0)                                  ║
╠════════════════════════════════════════════════════════════════════════════╣
║ 版本变更: 创建 v1.0.0 (初始创建)                                           ║
║ 理由: 为全栈云开发平台建立核心治理和现代化UI/UX重设计原则                   ║
║                                                                            ║
║ 修改的原则:                                                                ║
║   - 无 (新文档)                                                            ║
║                                                                            ║
║ 新增部分:                                                                  ║
║   + P1: 现代组件驱动架构 (Tremor + shadcn/ui)                              ║
║   + P2: 设计系统与视觉一致性                                               ║
║   + P3: 渐进式增强与响应式设计                                             ║
║   + P4: 性能与可访问性优先                                                 ║
║   + P5: 数据库感知的后端集成                                               ║
║   + P6: 可观测性和监控卓越性                                               ║
║   + P7: 类型安全性与代码质量                                               ║
║                                                                            ║
║ 需要更新的模板:                                                            ║
║   ⚠ .specify/templates/spec-template.md (待创建)                          ║
║   ⚠ .specify/templates/plan-template.md (待创建)                          ║
║   ⚠ .specify/templates/tasks-template.md (待创建)                         ║
║                                                                            ║
║ 批准日期: 2025-11-12                                                       ║
║ 最后修改日期: 2025-11-12                                                   ║
╚════════════════════════════════════════════════════════════════════════════╝
-->

# 项目宪法 v1.0.0

**项目**: 云开发全栈平台 (Coolify PostgreSQL AI分析)
**批准日期**: 2025-11-12
**最后修改**: 2025-11-12
**状态**: 有效

---

## 📋 概述

本宪法为云开发全栈平台建立了治理原则和技术标准。该项目结合了现代React前端 (使用Tremor + shadcn/ui组件)、Python FastAPI后端与PostgreSQL/pgvector、以及基于Coolify的云部署。

宪法优先考虑:
- **现代组件驱动的UI架构** 遵循业界标准设计系统
- **类型安全、可观测的后端服务** 使用Python + FastAPI + PostgreSQL
- **响应式、可访问的用户体验** 符合WCAG AA标准
- **可组合、可维护的代码库** 具有清晰的关注点分离
- **自动化的可观测性与监控** 从开发到生产的全过程

---

## 🎯 核心原则

### P1: 现代组件驱动架构

**原则声明**:
所有前端UI必须使用可组合、类型安全的组件模式构建，以Tremor (分析)和shadcn/ui (通用UI)作为基础组件库。组件必须设计为可重用、支持深色模式和渐进式增强。

**理由**:
- **Tremor** 提供预构建的、动画化的分析组件 (图表、KPI、表格)，具有内置的Tailwind样式和可访问性特性
- **shadcn/ui** 提供无样式、可访问的组件原语 (按钮、输入框、对话框、模态框) 可被组合和自定义
- 组合方法提供了一个"开箱即用但可自定义"的组件系统，消除重复实现工作
- 类型安全的组件属性 (TypeScript) 确保父子组件之间的契约
- 可组合架构支持快速功能交付和UI一致性

**不可协商的规则**:
1. 所有可重用UI元素必须在 `frontend/src/components/` 中实现为React组件
2. 禁止直接DOM操作 (refs、jQuery风格的查询)；仅使用React模式
3. 组件属性必须使用TypeScript接口或泛型类型化
4. 每个组件文件必须导出默认组件及伴随的故事 (Storybook) 或示例
5. 分析使用Tremor组件；通用UI使用shadcn/ui组件 (无重复)
6. 所有组件必须支持深色模式，通过Tailwind的 `dark:` 变体或CSS自定义属性

---

### P2: 设计系统与视觉一致性

**原则声明**:
视觉设计必须遵循文档化的设计系统规范 (色板、排版、间距、阴影、边框半径)，以确保在所有面向用户的表面上保持一致、专业的UX。

**理由**:
- 已发布的设计系统 (Tailwind配置 + 组件库) 减少了设计师和开发者的认知负担
- 一致的视觉语言增强品牌认同和用户信任
- 深色主题优先设计 (slate-900、slate-800背景配cyan/blue强调色) 符合现代财务仪表板美学
- 文档化的间距 (8px网格)、排版层级 (24px–10px比例) 和颜色语义 (成功=绿色、警告=琥珀色) 支持快速、正确的实现

**不可协商的规则**:
1. 所有颜色必须来自批准的调色板:
   - 背景: `#0f172a`, `#1e293b`, 渐变至 `#0f0f1e`
   - 主要强调: `#06b6d4` (cyan) 用于交互元素、图表
   - 次要强调: `#3b82f6` (blue) 用于图标、渐变
   - 功能颜色: green-500 (成功), amber-500 (警告), orange-600 (升级)
2. 所有排版必须使用系统字体栈: `-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`
3. 字体大小必须遵循8点比例: 36px (英雄)、24px (标题)、18px (卡片)、14px (正文)、12px (小号)、10px (大写)
4. 所有间距必须是8px的倍数 (4, 8, 16, 24, 32, 48)
5. 边框半径必须遵循: 8px (按钮/小)、16px (卡片)、20px (大)
6. 阴影必须使用Tailwind的阴影比例 (sm, md, lg) 或自定义深度令牌
7. 网格布局必须是桌面上的2列、移动设备上响应式的1列

---

### P3: 渐进式增强与响应式设计

**原则声明**:
所有功能必须使用渐进式增强构建: 在所有视口大小下功能完整、对旧浏览器优雅降级、对现代功能增强UX。移动优先的CSS-in-JS和响应式组件是强制的。

**理由**:
- 渐进式增强确保网络速度较慢或使用旧设备的用户仍能获得功能的核心体验
- 移动优先的响应式设计确保可扩展性并强制简化基本布局
- 断点一致性 (768px平板、1024px桌面) 支持可预测的扩展
- 懒加载和代码分割减少初始包并改进交互时间

**不可协商的规则**:
1. 所有布局必须使用CSS Flexbox或CSS Grid (无浮动或绝对定位黑客)
2. Tailwind断点是强制的: `sm` (640px), `md` (768px), `lg` (1024px), `xl` (1280px)
3. 移动导航: 侧边栏必须在屏幕 < 768px 时折叠为汉堡菜单
4. 触摸目标必须是移动设备上的最小44px × 44px
5. 图像必须使用 `<img loading="lazy">` 或Next/Remix图像优化进行懒加载
6. 表单输入必须包含可见的焦点状态 (轮廓、下划线或边框高亮)
7. 有50项以上的列表必须实现虚拟滚动 (React Window、TanStack Virtual)

---

### P4: 性能与可访问性优先

**原则声明**:
所有UI代码必须优先考虑性能 (< 100ms响应、< 3秒LCP) 和可访问性 (WCAG AA合规、键盘导航、屏幕阅读器支持)。这些不是可选的；它们是核心需求。

**理由**:
- 可访问性 (a11y) 既是道德当为也是法律合规要求
- 性能直接影响用户满意度、转换率和SEO排名
- 早期性能预算 (组件级) 防止后期重写
- ARIA标签、语义HTML和键盘导航确保包容性设计

**不可协商的规则**:
1. 所有交互元素必须可通过键盘导航 (Tab、Enter、Escape)
2. 所有图像和图标必须有 `alt` 文本描述目的 (如果装饰性则 `aria-hidden`)
3. 所有表单输入必须有相关的 `<label>` 元素配 `htmlFor` 属性
4. 颜色单独不能传达信息；包括文本、图标或图案
5. 文本对比度必须符合WCAG AA: 正常文本4.5:1、大号文本3:1
6. 加载状态必须显示骨架屏或旋转器 (无静默延迟 > 1秒)
7. 所有动画必须尊重 `prefers-reduced-motion` 媒体查询
8. Lighthouse审计分数: 性能≥80、可访问性=100 (或记录的例外)

---

### P5: 数据库感知的后端集成

**原则声明**:
所有后端服务 (FastAPI端点) 必须明确意识到数据库模式、查询模式和性能影响而设计。ORM使用 (SQLAlchemy) 必须强制执行懒加载防止、N+1查询感知和连接池。

**理由**:
- PostgreSQL + pgvector 是所有持久数据的事实来源
- ORM代码中的显式模式感知减少了错误 (ORM不匹配、缺失连接)
- 早期查询优化 (索引、急加载、分页) 防止数据量增长时的性能悬崖
- 连接池和超时管理防止资源耗尽

**不可协商的规则**:
1. 所有数据库模式必须通过Alembic迁移版本控制
2. 所有ORM模型必须声明关系，使用显式 `join`、`joinedload` 或 `selectinload` 策略 (API端点中禁止懒加载)
3. 所有查询必须包含分页 (limit、offset) 或大结果集的键集分页
4. 查询计数必须为每个API请求记录；如果检测到N+1查询则告警
5. 所有慢查询 (> 100ms) 必须被分析和索引
6. 连接池大小必须调整为预期的并发连接数 (非默认值)
7. 数据库超时必须设置: `pool_pre_ping=True`, `timeout=30` 秒最少

---

### P6: 可观测性与监控卓越性

**原则声明**:
所有系统 (前端和后端) 必须从最早的开发阶段开始发出结构化日志、指标和追踪。可观测性必须不是事后想法；它是架构。

**理由**:
- 结构化可观测性支持快速事件响应和根本原因分析
- 早期仪表化揭示了生产部署前的性能瓶颈和设计缺陷
- 指标 (响应时间、错误率、资源使用率) 指导扩展决策
- 日志、追踪和指标一起描绘了完整的运营图景

**不可协商的规则**:
1. 所有后端端点必须发出结构化JSON日志，包含:
   - `timestamp`, `level` (info/warn/error), `service`, `endpoint`, `method`, `status_code`, `duration_ms`
2. 所有错误必须包含堆栈追踪和上下文 (user_id、session_id、request_id)
3. 请求/响应追踪必须通过所有服务传播 `X-Request-ID` 头
4. 指标必须暴露 (Prometheus格式) 用于:
   - HTTP端点延迟 (p50、p95、p99)
   - 数据库查询延迟 (p50、p95、p99)
   - 错误率 (4xx、5xx计数)
   - 缓存命中/未命中率
   - 资源使用 (CPU、内存、连接)
5. 前端必须包含错误边界并发送错误报告给后端
6. 所有慢操作 (查询 > 100ms、API调用 > 500ms) 必须记录为警告
7. 必须暴露健康检查 (`/health`、`/readiness`、`/liveness`) 在后端和前端

---

### P7: 类型安全性与代码质量

**原则声明**:
所有代码 (Python后端、TypeScript前端) 必须在编译时使用静态类型检查。类型覆盖率必须保持在90%以上；任何 `# type: ignore` 注释必须有理由文档化。

**理由**:
- 静态类型在开发时捕获整个类别的错误 (不是在生产中)
- 类型提示作为可执行文档，改进开发者入职体验
- 强类型支持IDE自动完成、重构安全性和自信的重构
- 类型覆盖率指标防止类型安全的逐步侵蚀 ("仅这一个 `any`")

**不可协商的规则**:
1. **TypeScript (前端)**:
   - `strict: true` 在 `tsconfig.json` 中
   - 无隐式 `any` 类型; `noImplicitAny: true`
   - 所有函数签名必须有显式返回类型
   - React组件属性必须被类型化 (接口或泛型)
   - 类型覆盖率: ≥ 90% (通过 `type-coverage` 或TypeScript严格模式测量)

2. **Python (后端)**:
   - 所有函数签名必须包含类型提示 (参数和返回)
   - 使用 `from __future__ import annotations` 用于前向引用
   - Pydantic模型用于所有API请求/响应体
   - `mypy --strict` 在CI/CD中验证
   - 类型覆盖率: ≥ 90%

3. **一般**:
   - 无 `# type: ignore` 注释without内联理由
   - 所有异常必须被类型化 (继承自 `Exception` 带类型提示)
   - 单元测试必须验证类型契约 (例如，函数返回声明的类型)

---

## 🏛️ 治理

### 修订程序

1. **提议**: 修订必须作为pull请求提议至 `.specify/memory/constitution.md`
2. **理由**: 每个提议的变更必须包含理由部分，解释"为什么"
3. **审查**: 由技术主导和1名以上核心贡献者审查提议
4. **批准**: 通过PR合并批准 (共识驱动)
5. **版本**: 修订必须按semver规则增加版本:
   - **MAJOR**: 原则移除或向后不兼容的重新定义
   - **MINOR**: 新原则或指导的显著扩展
   - **PATCH**: 澄清、措辞、拼写修复

### 合规审查

- **频率**: 季度 (每3个月)
- **所有者**: 技术主导
- **范围**: 审查所有活跃功能、分支和PR对照宪法
- **报告**: 合规报告发布在项目README或治理wiki
- **执行**: 不合规PR被阻止直到补救

### 版本政策

- **版本格式**: `vMAJOR.MINOR.PATCH` (语义版本)
- **批准日期**: ISO 8601格式 (YYYY-MM-DD)
- **修改日期**: 任何变更时更新；反映最后实质性更新
- **变更日志**: 所有修订在本文档中记录，带日期和版本

---

## 📊 原则概要表

| 原则 | 焦点 | 关键工件 |
|------|------|---------|
| **P1** | 组件架构 | Tremor、shadcn/ui、TypeScript组件规范 |
| **P2** | 视觉一致性 | Tailwind配置、design-specification.md、颜色令牌 |
| **P3** | 响应式设计 | 断点策略、移动优先CSS、懒加载 |
| **P4** | 性能与a11y | WCAG AA、Lighthouse 80+、< 3s LCP、键盘导航 |
| **P5** | 数据库模式 | Alembic迁移、SQLAlchemy显式加载、分页 |
| **P6** | 可观测性 | 结构化日志、Prometheus指标、追踪 |
| **P7** | 类型安全 | TypeScript strict、Python mypy、90%覆盖 |

---

## ✅ 实现检查清单

### 前端 (Tremor + shadcn/ui)
- [ ] 安装Tremor和shadcn/ui依赖
- [ ] 配置Tailwind CSS with深色模式支持
- [ ] 创建组件库目录结构
- [ ] 记录颜色系统和间距规则
- [ ] 使用Tremor构建仪表板/分析页面
- [ ] 实现响应式导航 (侧边栏折叠)
- [ ] 添加Storybook用于组件文档
- [ ] 审计可访问性 (WAVE、axe DevTools)

### 后端 (FastAPI + PostgreSQL)
- [ ] 设置Alembic迁移
- [ ] 创建SQLAlchemy模型with显式加载策略
- [ ] 实现结构化日志 (JSON格式)
- [ ] 添加Prometheus指标导出
- [ ] 创建健康检查端点 (`/health`、`/readiness`)
- [ ] 设置请求ID追踪 (`X-Request-ID`)
- [ ] 配置连接池
- [ ] 添加mypy严格类型检查到CI/CD

### DevOps与监控
- [ ] 配置Docker构建with多阶段优化
- [ ] 设置GitHub Actions CI/CD
- [ ] 集成Coolify部署管道
- [ ] 配置日志聚合 (CloudWatch、Datadog或类似)
- [ ] 为错误率和延迟设置告警
- [ ] 记录常见事件的运行手册

---

## 📚 相关文档

- **设计规范**: `docs/prd/desgin/design-specification.md`
  (颜色系统、排版、布局规则、组件模式)

- **组件库**: `frontend/src/components/`
  (Tremor + shadcn/ui组件、Storybook故事)

- **后端架构**: `backend/src/`
  (FastAPI路由、SQLAlchemy模型、可观测性)

- **部署指南**: `QUICK_START.md`、`DOCKER_DEPLOYMENT.md`
  (Coolify配置、Docker构建、健康检查)

---

## 🔄 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| **v1.0.0** | 2025-11-12 | 初始宪法: P1–P7原则、治理结构、设计系统集成 |

---

## 📝 注意

- 本宪法是一份**生活文档**。定期审查和修订预期随着项目演进。
- 每个原则包括明确的"不可协商的规则"，指导代码审查、测试和部署控制。
- 合规通过自动检查 (类型覆盖、linting、可访问性审计) 和PR评估期间的手动审查来测量。
- 组合的Tremor + shadcn/ui方法优先考虑开发者速度，同时维持设计一致性和组件可重用性。

---

**宪法所有者**: Jack (技术主导)
**最后审查**: 2025-11-12
**下次审查应于**: 2026-02-12 (Q1)
